<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/DragoGame.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> DragoGame.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">97.73% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>43/44</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">84% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>42/50</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>62/62</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">30×</span>
<span class="cline-any cline-yes">29×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity 0.8.26;
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol"; // Import for security against reentrancy attacks // ! 1
import "@openzeppelin/contracts/access/Ownable.sol"; // Import for access control
contract DragoGame is ReentrancyGuard, Ownable {
    // Struct to define the structure of an Event - Requirement: Struct
    struct Event {
        uint256 startTime;
        uint256 highestScore;
        address highestScorer;
        uint256 playerCount;
        uint256 submittedScores;
        mapping(address =&gt; uint256) playerEntries; // Requirement: Mapping
        mapping(address =&gt; uint256) submittedScoreCount;
    }
&nbsp;
    uint256 public constant EVENT_DURATION = 15 minutes;
    uint256 public constant MAX_PLAYERS = 5;
    uint256 public constant ENTRY_FEE = 1 ether;
    uint256 public constant PRIZE = 2 ether;
&nbsp;
    Event public currentEvent;
    bool public eventActive;
&nbsp;
    address[] public registeredPlayers; // New array to store all registered player addresses
&nbsp;
    // Custom errors for gas efficiency - Requirement: Custom Error
    error NotRegistered();
    error EventNotActive();
    error GameFull();
    error IncorrectFee();
&nbsp;
    // Events for logging important actions - Requirement: Events for logging
    event GameStarted(uint256 startTime);
    event PlayerJoined(address player);
    event NewHighScore(address player, uint256 score);
    event EventEnded(address winner, uint256 winningScore);
    event EventClosedByAdmin(address highestScorer, uint256 highestScore);
    event ScoreSubmitted(address player, uint256 score);
    event FeesWithdrawn(address owner, uint256 amount);
    event EtherReceived(address indexed sender, uint256 value);
&nbsp;
    // Constructor initializes the owner - Requirement: Constructor
    constructor() Ownable(msg.sender) {}
&nbsp;
    // Custom modifier for checking if the player is registered - Requirement: Custom Modifier
    modifier onlyRegistered() {
        if (currentEvent.playerEntries[msg.sender] == 0) revert NotRegistered();
        _;
    }
&nbsp;
    // Function to start a game, fulfilling event management - Partial Requirement for event registration
    function startGame() external payable <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
        require(!eventActive, "An event is already active"); // Adding require for clarity and to meet the requirement of one require statement // ! =) 
        if (msg.value != ENTRY_FEE) revert IncorrectFee(); // Gas optimization: using custom error instead of require // ! 2
&nbsp;
        eventActive  = false;
&nbsp;
        // Reset current event
        delete currentEvent;
        // Clear registered players
        delete registeredPlayers;
&nbsp;
        // Start new event
        eventActive = true;
        currentEvent.startTime = block.timestamp; // Gas optimization: using block.timestamp instead of now // ! 3 
        currentEvent.playerCount = 1;
        currentEvent.submittedScores = 0;
        currentEvent.playerEntries[msg.sender] = 1;
        <span class="missing-if-branch" title="else path not taken" >E</span>if(currentEvent.playerEntries[msg.sender] == 1) { // Check if this is the first entry for this address
            registeredPlayers.push(msg.sender);
        }
&nbsp;
        // ! Score submitting to a consecutive event will not be possible without this
        // ! Somehow still believe it is in the last event and will not be able to submit scores
        // Explicitly initialize mappings for the new event
        currentEvent.playerEntries[msg.sender] = 1;
        currentEvent.submittedScoreCount[msg.sender] = 0;  // Reset submitted scores count for this player
&nbsp;
        emit GameStarted(currentEvent.startTime);
        emit PlayerJoined(msg.sender);
    }
&nbsp;
    // Function to join an ongoing game - Partial Requirement for event registration
    function joinGame() external payable <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
        if (!eventActive) revert EventNotActive(); // Requirement: Revert if event is not active one of maaany revert statements
        if (msg.value != ENTRY_FEE) revert IncorrectFee();
        if (currentEvent.playerCount &gt;= MAX_PLAYERS) revert GameFull();
        if (block.timestamp &gt; currentEvent.startTime + EVENT_DURATION) revert EventNotActive();
&nbsp;
        currentEvent.playerCount++;
        currentEvent.playerEntries[msg.sender]++;
        if(currentEvent.playerEntries[msg.sender] == 1) { // If this player wasn't already registered
            registeredPlayers.push(msg.sender);
        }
&nbsp;
        emit PlayerJoined(msg.sender);
    }
&nbsp;
    // Function to submit a score, uses custom modifier - Requirement: Use of Custom Modifier
function submitScore(uint256 score) external onlyRegistered <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!eventActive) revert EventNotActive();
    if (currentEvent.submittedScoreCount[msg.sender] &gt;= currentEvent.playerEntries[msg.sender]) revert("No more scores to submit for this entry");
&nbsp;
    uint256 previousHighestScore = currentEvent.highestScore; // Store the current highest score
&nbsp;
    currentEvent.submittedScoreCount[msg.sender]++;
    currentEvent.submittedScores++;
&nbsp;
    if (score &gt; currentEvent.highestScore) {
        currentEvent.highestScore = score;
        currentEvent.highestScorer = msg.sender;
        emit NewHighScore(msg.sender, score);
    }
&nbsp;
    assert(currentEvent.highestScore &gt;= previousHighestScore); // Requirement: Assert
&nbsp;
    emit ScoreSubmitted(msg.sender, score);
}
&nbsp;
    function endEventAndClaimPrize() external <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!eventActive) revert EventNotActive();
        if (!(block.timestamp &gt;= currentEvent.startTime + EVENT_DURATION || currentEvent.submittedScores == currentEvent.playerCount)) revert("Event not ready to end");
        if (msg.sender != currentEvent.highestScorer) revert("Only highest scorer can end the event");
&nbsp;
        eventActive = false;
        address winner = currentEvent.highestScorer;
        uint256 winningScore = currentEvent.highestScore;
&nbsp;
        payable(winner).transfer(PRIZE);
&nbsp;
        emit EventEnded(winner, winningScore);
&nbsp;
        delete currentEvent;
        delete registeredPlayers; // Clear the registered players array
    }
&nbsp;
    function adminCloseEvent() external onlyOwner {
        if (!eventActive) revert("No active event to close");
&nbsp;
        eventActive = false;
&nbsp;
        emit EventClosedByAdmin(currentEvent.highestScorer, currentEvent.highestScore);
&nbsp;
        delete currentEvent;
        delete registeredPlayers; // Clear the registered players array
    }
&nbsp;
    function withdrawFees() external onlyOwner {
        uint256 balance = address(this).balance;
        if (balance == 0) revert("No fees to withdraw");
&nbsp;
        (bool success, ) = payable(owner()).call{value: balance}("");
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!success) <span class="cstat-no" title="statement not covered" >revert("Transfer failed")</span>;
&nbsp;
        emit FeesWithdrawn(owner(), balance);
    }
&nbsp;
    function getCurrentEventDetails() external view returns (
        uint256 startTime,
        uint256 highestScore,
        address highestScorer,
        uint256 playerCount,
        uint256 submittedScores
    ) {
        return (
            currentEvent.startTime,
            currentEvent.highestScore,
            currentEvent.highestScorer,
            currentEvent.playerCount,
            currentEvent.submittedScores
        );
    }
&nbsp;
    // Updated function to get all registered players - Requirement: List of registered participants
    function getRegisteredPlayers() external view returns (address[] memory) {
        return registeredPlayers;
    }
&nbsp;
    // Receive function for handling incoming Ether - Requirement: Receive function
    receive() external payable {
        emit EtherReceived(msg.sender, msg.value);
    }
&nbsp;
    // Fallback function to prevent accidental Ether sending - Requirement: Fallback function
    fallback() external payable {
        revert("Direct Ether transfer not allowed");
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Sep 06 2024 18:50:47 GMT+0200 (Central European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
